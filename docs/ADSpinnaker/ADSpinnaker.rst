======================================
ADASpinnaker
======================================

:author: Mark Rivers, University of Chicago

.. contents:: Contents

.. _GenICam:      https://www.emva.org/standards-technology/genicam
.. _aravis:       https://github.com/AravisProject/aravis
.. _ADGenICam:    https://github.com/areaDetector/ADGenICam
.. _ADAravis:     https://github.com/areaDetector/ADAravis
.. _ADSpinnaker:  https://github.com/areaDetector/ADSpinnaker
.. _ADVimba:      https://github.com/areaDetector/ADVimba
.. _ADSupport:    https://github.com/areaDetector/ADSupport
.. _Spinnaker:    https://www.flir.com/products/spinnaker-sdk

Overview
--------

This is an :doc:`../index` driver for GenICam_ cameras using the Spinnaker_ library.

GenICam_ is a Generic Interface for Cameras from the European Machine Vision Association (EMVA). 

ADSpinnaker is derived from the base class ADGenICam_, which handles many of the details of
mapping GenICam_ features to EPICS records. 

As it name implies, ADSpinnaker_ uses the FLIR/Point Grey Spinnaker_ library.
It runs on Windows, and on Linux with Ubuntu 18 and higher.  
It does not run on other most older Linux versions (e.g. Centos 7/RHEL 7) because
the FLIR Spinnaker SDK is compiled with a very recent gcc version and thus requires
new versions of GLIBC and GLIBCXX.

Prior to using ADSpinnaker with a specific camera model, the XML file must be read from the camera using the arv-tool utility, 
and the EPICS database file and OPI screens must be generated by running the Python programs in 
:ref:`ADGenICam Python scripts <ADGenICam_Python_scripts>`.


ADSpinnaker driver
---------------
ADSpinnaker inherits from :doc:`../ADGenICam/ADGenICam`.  It adds the following parameters and EPICS records that are
specific to ADSpinnaker.

.. cssclass:: table-bordered table-striped table-hover
.. list-table::
   :header-rows: 1
   :widths: auto

   * - EPICS record names
     - Record types
     - drvInfo string
     - Description
   * - TimeStampMode, TimeStampMode_RBV
     - bo, bi
     - SP_TIME_STAMP_MODE
     - Controls whether the TimeStamp attribute comes from the camera internal time stamp or from the EPICS time.
       Choices are Camera (0), and EPICS (1).
   * - UniqueIdMode, UniqueIdMode_RBV
     - bo, bi
     - SP_UNIQUE_ID_MODE
       Controls whether the UniqueId attribute comes from the camera internal value or from the driver.
       Choices are Camera (0), and Driver (1).
   * - ConvertPixelFormat, ConvertPixelFormat_RBV
     - mbbo, mbbi
     - SP_CONVERT_PIXEL_FORMAT
     - Controls conversion of the pixel format read from the camera to a different format.  For example this can be used
       to convert Mono12Packed to Mono16, which allows the camera to send 12-bit data over the bus and then convert to 16-bit
       on the host computer, reducing the required bandwidth and increasing the frame rate.
   * - FailedPacketCount
     - longin
     - SP_FAILED_PACKET_COUNT
     - Failed packet count
   * - FailedBufferCount
     - longin
     - SP_FAILED_BUFFER_COUNT
     - Failed buffer count
   * - BufferUnderrunCount
     - longin
     - SP_BUFFER_UNDERRUN_COUNT
     - Buffer underrun count


IOC startup script
------------------
The command to configure an ADAravis camera in the startup script is::

  ADSpinnakerConfig(const char *portName, const char *cameraId, int traceMask, int memoryChannel,
                    size_t maxMemory, int priority, int stackSize)

``portName`` is the name for the ADSpinnaker port driver

``cameraId`` is the either the serial number of the camera or the camera index number in the system.  The serial number is normally printed
on the camera, and it is also the last part of the camera name returned by arv-tool, for example for
``"Point Grey Research-Blackfly S BFS-PGE-50S5C-18585624"``, it would be 18585624. 
If cameraId is less than 1000 it is assumed to be the system index number, if 1000 or greater it is assumed to be a serial number.

``traceMask`` is the initial value of asynTraceMask to be used for debugging problems in the constructor.

``memoryChannel`` is the internal channel number in the camera to be used for saved cameras settings.

``maxMemory`` is the maximum amount of memory the NDArrayPool is allowed to allocate.  0 means unlimited.

``priority`` is the priority of the port thread.  0 means medium priority.

``stackSize`` is the stack size.  0 means medium size.

MEDM screens
------------
The following is the MEDM screen ADAravis.adl when controlling a FLIR Oryx 51S5M 10 Gbit Ethernet camera.
ADAravis.adl is very similar to ADGenICam.adl, with a few additional widgets for the PVs that are 
specific to ADAravis.

Note that each frame is 4.8 MB, and it is collecting 162 frames/s, which is 775 MB/s. 

.. figure:: ADAravis.png
    :align: center

The following is the MEDM screen FLIR_ORX_10g_51S5M-features1.adl when controlling a FLIR Oryx 51S5M 10 Gbit Ethernet camera.
This screen was autogenerated by the Python script in :doc:`../ADGenICam/ADGenICam`, and is specific to this camera model.
It is loaded from the "Camera-specific features" related display widget in the above screen.

.. figure:: ADAravis_features1.png
    :align: center

The following is the second feature screen generated by the Python program described above.

.. figure:: ADAravis_features2.png
    :align: center

